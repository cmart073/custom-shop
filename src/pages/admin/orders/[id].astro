---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getOrderById, getOrderUploads } from '../../../lib/database';
import { 
  formatStatus, 
  formatServiceType, 
  formatGripService, 
  formatDate, 
  formatPrice, 
  formatPriceRange,
  ORDER_STATUSES 
} from '../../../lib/validation';

const { id } = Astro.params;
const db = Astro.locals.runtime.env.DB;
const r2 = Astro.locals.runtime.env.R2;

const order = await getOrderById(db, id as string);

if (!order) {
  return Astro.redirect('/admin/orders?error=not_found');
}

const uploads = await getOrderUploads(db, order.id);

// Generate presigned URLs for images (or use public URL if configured)
const imageUrls = await Promise.all(
  uploads.map(async (upload) => {
    // For R2, we'll construct a URL pattern that works with the API
    return {
      ...upload,
      url: `/api/images/${upload.r2_key}`,
    };
  })
);

const paintConditionLabels: Record<string, string> = {
  good: 'Good Condition',
  chipped: 'Chipped',
  strip_redo: 'Strip & Redo',
};

const paintStyleLabels: Record<string, string> = {
  single_color: 'Single Color',
  multi_color: 'Multi-Color',
  match_theme: 'Match Theme/Bag',
};

const gripSizeLabels: Record<string, string> = {
  standard: 'Standard',
  midsize: 'Midsize',
  jumbo: 'Jumbo',
};
---

<AdminLayout title={`Order ${order.short_id}`}>
  <div class="admin-order-detail">
    <header class="order-header">
      <div class="header-left">
        <a href="/admin/orders" class="back-link">← Back to Orders</a>
        <h1>Order {order.short_id}</h1>
        <p class="order-meta">
          Submitted {formatDate(order.created_at)}
        </p>
      </div>
      <div class="header-right">
        <span class={`status-badge status-${order.status}`}>
          {formatStatus(order.status)}
        </span>
      </div>
    </header>

    <div class="order-grid">
      <div class="main-content">
        <!-- Customer Information -->
        <section class="order-section">
          <h2>Customer Information</h2>
          <dl class="detail-list">
            <div class="detail-row">
              <dt>Name</dt>
              <dd>{order.full_name}</dd>
            </div>
            <div class="detail-row">
              <dt>Email</dt>
              <dd><a href={`mailto:${order.email}`}>{order.email}</a></dd>
            </div>
            {order.phone && (
              <div class="detail-row">
                <dt>Phone</dt>
                <dd><a href={`tel:${order.phone}`}>{order.phone}</a></dd>
              </div>
            )}
            <div class="detail-row">
              <dt>Preferred Contact</dt>
              <dd style="text-transform: capitalize;">{order.preferred_contact_method}</dd>
            </div>
            <div class="detail-row full-width">
              <dt>Shipping Address</dt>
              <dd class="address">{order.shipping_address}</dd>
            </div>
          </dl>
        </section>

        <!-- Service Details -->
        <section class="order-section">
          <h2>Service Details</h2>
          <dl class="detail-list">
            <div class="detail-row">
              <dt>Service Type</dt>
              <dd>{formatServiceType(order.service_type)}</dd>
            </div>
            {order.service_type !== 'grips_only' && (
              <>
                <div class="detail-row">
                  <dt>Club Count</dt>
                  <dd>{order.club_count}</dd>
                </div>
                <div class="detail-row">
                  <dt>Paint Condition</dt>
                  <dd>{paintConditionLabels[order.current_paint_condition || ''] || order.current_paint_condition}</dd>
                </div>
                <div class="detail-row">
                  <dt>Paint Style</dt>
                  <dd>{paintStyleLabels[order.paint_style || ''] || order.paint_style}</dd>
                </div>
                <div class="detail-row">
                  <dt>Primary Color</dt>
                  <dd>
                    <span class="color-preview" style={`background-color: ${order.primary_color};`}></span>
                    {order.primary_color}
                  </dd>
                </div>
                {order.secondary_color && (
                  <div class="detail-row">
                    <dt>Secondary Color</dt>
                    <dd>
                      <span class="color-preview" style={`background-color: ${order.secondary_color};`}></span>
                      {order.secondary_color}
                    </dd>
                  </div>
                )}
              </>
            )}
          </dl>
        </section>

        <!-- Grip Service -->
        {order.grip_service !== 'none' && (
          <section class="order-section">
            <h2>Grip Service</h2>
            <dl class="detail-list">
              <div class="detail-row">
                <dt>Service</dt>
                <dd>{formatGripService(order.grip_service)}</dd>
              </div>
              <div class="detail-row">
                <dt>Grip Count</dt>
                <dd>{order.grip_count}</dd>
              </div>
              {order.grip_model && (
                <div class="detail-row">
                  <dt>Grip Model</dt>
                  <dd>{order.grip_model}</dd>
                </div>
              )}
              <div class="detail-row">
                <dt>Grip Size</dt>
                <dd>{gripSizeLabels[order.grip_size || ''] || order.grip_size}</dd>
              </div>
              {order.extra_wraps !== null && order.extra_wraps > 0 && (
                <div class="detail-row">
                  <dt>Extra Wraps</dt>
                  <dd>{order.extra_wraps}</dd>
                </div>
              )}
            </dl>
          </section>
        )}

        <!-- Customer Notes -->
        {order.notes && (
          <section class="order-section">
            <h2>Customer Notes</h2>
            <div class="notes-content">
              {order.notes}
            </div>
          </section>
        )}

        <!-- Photo Gallery -->
        <section class="order-section">
          <h2>Photos ({uploads.length})</h2>
          {uploads.length > 0 ? (
            <div class="image-gallery">
              {imageUrls.map((image) => (
                <a href={image.url} target="_blank" rel="noopener" class="gallery-item">
                  <img src={image.url} alt={image.original_filename} loading="lazy" />
                  <span class="image-filename">{image.original_filename}</span>
                </a>
              ))}
            </div>
          ) : (
            <p class="no-images">No photos uploaded</p>
          )}
        </section>
      </div>

      <aside class="sidebar">
        <!-- Pricing -->
        <section class="order-section pricing-section">
          <h2>Pricing</h2>
          <div class="price-display">
            <div class="price-row">
              <span class="price-label">Estimate</span>
              <span class="price-value">{formatPriceRange(order.est_price_min, order.est_price_max)}</span>
            </div>
            {order.quoted_price !== null && (
              <div class="price-row quoted">
                <span class="price-label">Quoted Price</span>
                <span class="price-value">{formatPrice(order.quoted_price)}</span>
              </div>
            )}
          </div>
        </section>

        <!-- Admin Actions -->
        <section class="order-section admin-section">
          <h2>Admin Actions</h2>
          <form id="admin-form" class="admin-form">
            <input type="hidden" name="orderId" value={order.id} />
            
            <div class="form-group">
              <label for="status">Status</label>
              <select id="status" name="status">
                {ORDER_STATUSES.map((status) => (
                  <option value={status} selected={order.status === status}>
                    {formatStatus(status)}
                  </option>
                ))}
              </select>
            </div>

            <div class="form-group">
              <label for="quotedPrice">Quoted Price ($)</label>
              <input 
                type="number" 
                id="quotedPrice" 
                name="quotedPrice" 
                step="1" 
                min="0"
                value={order.quoted_price !== null ? (order.quoted_price / 100).toFixed(0) : ''}
                placeholder="Enter final price"
              />
            </div>

            <div class="form-group">
              <label for="adminNotes">Admin Notes</label>
              <textarea 
                id="adminNotes" 
                name="adminNotes" 
                rows="4"
                placeholder="Internal notes about this order..."
              >{order.admin_notes || ''}</textarea>
            </div>

            <button type="submit" class="btn btn-primary btn-block" id="save-btn">
              Save Changes
            </button>

            <div id="save-status" class="save-status"></div>
          </form>
        </section>
      </aside>
    </div>
  </div>
</AdminLayout>

<style>
  .admin-order-detail {
    max-width: 1200px;
    margin: 0 auto;
  }

  .order-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
  }

  .back-link {
    display: inline-block;
    color: var(--text-muted);
    text-decoration: none;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
  }

  .back-link:hover {
    color: var(--primary);
  }

  .order-header h1 {
    margin: 0;
    font-size: 1.75rem;
    color: var(--text);
  }

  .order-meta {
    margin: 0.25rem 0 0 0;
    color: var(--text-muted);
    font-size: 0.875rem;
  }

  .order-grid {
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 2rem;
  }

  @media (max-width: 900px) {
    .order-grid {
      grid-template-columns: 1fr;
    }
  }

  .order-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .order-section h2 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 1rem 0;
    color: var(--text);
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
  }

  .detail-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin: 0;
  }

  .detail-row {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .detail-row.full-width {
    grid-column: 1 / -1;
  }

  .detail-row dt {
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
  }

  .detail-row dd {
    margin: 0;
    font-size: 0.9375rem;
    color: var(--text);
  }

  .detail-row dd a {
    color: var(--primary);
    text-decoration: none;
  }

  .detail-row dd a:hover {
    text-decoration: underline;
  }

  .address {
    white-space: pre-wrap;
    line-height: 1.5;
  }

  .color-preview {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 3px;
    border: 1px solid var(--border);
    vertical-align: middle;
    margin-right: 0.5rem;
  }

  .notes-content {
    white-space: pre-wrap;
    color: var(--text);
    line-height: 1.6;
    font-size: 0.9375rem;
  }

  .image-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
  }

  .gallery-item {
    display: block;
    aspect-ratio: 1;
    border-radius: var(--radius);
    overflow: hidden;
    position: relative;
    background: var(--surface-alt);
    border: 1px solid var(--border);
  }

  .gallery-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.2s ease;
  }

  .gallery-item:hover img {
    transform: scale(1.05);
  }

  .image-filename {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0.5rem;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    color: #fff;
    font-size: 0.6875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .no-images {
    color: var(--text-muted);
    font-style: italic;
    margin: 0;
  }

  /* Sidebar */
  .pricing-section .price-display {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .price-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: var(--surface-alt);
    border-radius: var(--radius-sm);
  }

  .price-row.quoted {
    background: var(--primary);
    color: #fff;
  }

  .price-label {
    font-size: 0.8125rem;
    font-weight: 500;
  }

  .price-value {
    font-size: 1.125rem;
    font-weight: 600;
  }

  .admin-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .form-group label {
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--text);
  }

  .form-group select,
  .form-group input,
  .form-group textarea {
    padding: 0.625rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.9375rem;
    font-family: inherit;
    background: var(--surface);
    color: var(--text);
  }

  .form-group select:focus,
  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(30, 58, 47, 0.1);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 100px;
  }

  .btn-block {
    width: 100%;
  }

  .save-status {
    text-align: center;
    font-size: 0.875rem;
    min-height: 1.5rem;
  }

  .save-status.success {
    color: var(--success);
  }

  .save-status.error {
    color: var(--danger);
  }

  .status-badge {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    border-radius: var(--radius-sm);
    font-size: 0.8125rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .status-pending { background: #fef3c7; color: #92400e; }
  .status-received { background: #dbeafe; color: #1e40af; }
  .status-in_progress { background: #e0e7ff; color: #3730a3; }
  .status-completed { background: #d1fae5; color: #065f46; }
  .status-shipped { background: #f3e8ff; color: #6b21a8; }
  .status-cancelled { background: #fee2e2; color: #991b1b; }
</style>

<script>
  const form = document.getElementById('admin-form') as HTMLFormElement;
  const saveBtn = document.getElementById('save-btn') as HTMLButtonElement;
  const saveStatus = document.getElementById('save-status') as HTMLDivElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';
    saveStatus.textContent = '';
    saveStatus.className = 'save-status';

    const formData = new FormData(form);
    const orderId = formData.get('orderId') as string;
    const status = formData.get('status') as string;
    const quotedPriceStr = formData.get('quotedPrice') as string;
    const adminNotes = formData.get('adminNotes') as string;

    // Convert dollars to cents
    const quotedPrice = quotedPriceStr ? Math.round(parseFloat(quotedPriceStr) * 100) : null;

    try {
      const response = await fetch(`/api/orders/${orderId}/update`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          status,
          quotedPrice,
          adminNotes: adminNotes || null,
        }),
      });

      if (response.ok) {
        saveStatus.textContent = '✓ Changes saved';
        saveStatus.className = 'save-status success';
        
        // Update status badge on page
        const statusBadge = document.querySelector('.status-badge');
        if (statusBadge) {
          statusBadge.className = `status-badge status-${status}`;
          const statusLabels: Record<string, string> = {
            pending: 'Pending',
            received: 'Received',
            in_progress: 'In Progress',
            completed: 'Completed',
            shipped: 'Shipped',
            cancelled: 'Cancelled',
          };
          statusBadge.textContent = statusLabels[status] || status;
        }
      } else {
        const error = await response.json();
        saveStatus.textContent = error.message || 'Failed to save';
        saveStatus.className = 'save-status error';
      }
    } catch (error) {
      saveStatus.textContent = 'Network error';
      saveStatus.className = 'save-status error';
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save Changes';
    }
  });
</script>
